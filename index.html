<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trailprint Atlas</title>
    <!-- Add Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        body { 
            margin: 0; 
            font-family: sans-serif; 
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            font-size: 2.5em;
        }
        /* --- Navigation Bar --- */
        nav {
            background-color: #333;
            padding: 10px 20px;
            text-align: center;
        }
        nav a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-weight: bold;
        }
        nav a:hover {
            text-decoration: underline;
        }
        /* Style for our custom hike icons (for viewpoints) */
        .hike-icon {
            /* This creates a circular, semi-transparent white "puck" behind the icon to make it pop. */
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%; /* This makes the background circular */
            /* This adds a subtle dark outline to the white circle, helping it stand out on light backgrounds. */
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
        }
        /* --- Showcase Map Styles --- */
        .showcase-map-container {
            position: relative;
            height: 60vh; /* Make the hero map taller */
            cursor: pointer;
            overflow: hidden; /* Hide anything that might stick out */
            display: block; /* Ensures the link takes up the full container space */
        }
        .hero-title-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensures the title is on top of the map tiles */
        }
        #home-map {
            height: 100%;
            width: 100%;
            background-color: #1d1d1d; /* Dark background to hide satellite tile seams */
        }
        /* Keyframe animation for the "breathing" glow effect */
        @keyframes breathing-glow {
            0% { opacity: 0.4; }
            50% { opacity: 0.7; }
            100% { opacity: 0.4; }
        }
        /* Class to apply the animation to our halo layers */
        .breathing-halo {
            /* ease-in-out makes the pulse smooth */
            animation: breathing-glow 4s ease-in-out infinite;
        }
        /* Add a smooth transition for the trail fade-in effect */
        .leaflet-path.trail-path {
            transition: opacity 1.5s ease-in, fill-opacity 1.5s ease-in;
        }
        .map-overlay {
            /* This ensures the overlay doesn't cover our new stats panel */
            pointer-events: none;
        }
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.2); /* Dark overlay */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .showcase-map-container:hover .map-overlay {
            opacity: 1;
        }
        .map-overlay h3 {
            margin: 0;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        .map-overlay p {
            margin-top: 10px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .hero-title-overlay h1 {
            font-size: 4.5em;
            color: rgba(255, 255, 255, 0.50); /* Make the title slightly transparent to let the map shine through */
            margin: 0;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.8);
            pointer-events: none; /* Make sure title doesn't block the link */
        }
        .container {
            max-width: 900px; /* Widen container for more space */
            margin: 40px auto;
            padding: 20px;
            text-align: center;
            /* Add some structure and background to the dashboard area */
            background-color: #f9f9f9; /* A light gray */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* Very subtle shadow */
            padding: 40px 20px; /* Increase padding */
            max-width: 1000px; /* Allow it to stretch a bit more */
        }
        /* --- Stats Panel Styles --- */
        .stats-dashboard {
            display: flex;
            justify-content: center; /* Center the groups */
            gap: 20px; /* Space between the stat "bubbles" */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            margin: 30px auto 0 auto; /* Spacing for above and below the map */
        }
        .stat-group {
            display: flex; /* Aligns stat items within a group */
            align-items: center;
            padding: 15px 30px;
            /* Style each group as a "bubble" or card */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            border: 1px solid #e9e9e9;
        }
        /* New rule to add a divider between stat items */
        .stat-group > .stat-item + .stat-item {
            padding-left: 30px;
            margin-left: 30px;
            border-left: 1px solid #eee;
        }
        .stat-group--emphasized {
            /* A darker, more premium "bubble" to make these stats pop */
            background-color: #2c3e50; /* Dark blue-gray */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            padding: 25px 40px;
            transform: translateY(-5px); /* Slightly lift the element */
        }
        .stat-group--emphasized .stat-item .number {
            font-size: 2.4em; /* Larger font for the numbers */
            color: #f1c40f; /* A striking gold color that pops on the dark background */
        }
        .stat-group--emphasized .stat-item .label {
            color: #bdc3c7; /* A light gray for readability on the dark background */
        }
        /* Remove the divider for emphasized stats since they are in separate bubbles */
        .stat-group--emphasized > .stat-item + .stat-item { border-left: none; }
        
        .personal-records-section {
            margin-top: 60px; /* Add more space between the key stats and achievements */
        }
        .record-card {
            background-color: #fff;
            border: 1px solid #e9e9e9;
            border-left: 5px solid #3498db; /* A cool blue accent to make them stand out */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 25px;
            position: relative; /* For icon positioning */
            padding-left: 80px; /* Make more space for the icon */
            flex: 1 1 45%; /* Use a percentage-based flex-basis to ensure two cards fit per row */
            text-align: left; /* Align text to the left for a more formal look */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box; /* This is the key fix: it includes padding/border in the element's total width */
        }
        .record-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        /* A simple placeholder icon for each card */
        .record-card::before {
            font-size: 2.5em; /* Make icons a bit larger */
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #3498db;
            opacity: 0.7;
        }
        /* Custom icons for each record using emojis */
        .record-card:nth-of-type(1)::before { content: 'üìè'; } /* Ruler for longest hike */
        .record-card:nth-of-type(2)::before { content: 'üßó'; } /* Climber for biggest climb */
        .record-card:nth-of-type(3)::before { content: 'üèîÔ∏è'; } /* Mountain for highest summit */
        .record-card:nth-of-type(4)::before { content: 'üóìÔ∏è'; } /* Calendar for busiest month */

        /* Custom styles for text inside record cards */
        .record-card .number { font-size: 2.2em; }
        .record-card .label {
            color: #333; /* Slightly darker label for better contrast */
        }
        .record-card .sub-label {
            font-style: italic; /* Differentiate the hike name from the main label */
            color: #666;
        }

        .stat-item {
            text-align: center;
            color: #555;
        }
        .stat-item .number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50; /* A strong, dark blue/gray */
            display: block;
            margin-bottom: 5px;
        }
        .stat-item .date-number {
            font-size: 1.4em; /* Slightly smaller for date strings */
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        .stat-item .label {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sub-label {
            font-size: 1em; /* Make it slightly more prominent */
            color: #777;
            margin-top: 4px;
        }
        .dashboard-title { 
            font-size: 2.2em; /* Make title bigger to match emphasized stats */
            font-weight: 600;
            color: #333;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0; 
        }
        /* --- Region Spotlight Section --- */
        .state-icon-grid { /* Renamed class */
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap onto the next line on smaller screens */
            justify-content: center; /* This is the key: it centers the items horizontally */
            gap: 50px;
            margin-top: 30px;
        }
        
        .state-icon { /* Style the icons directly */
            width: 260px; /* Size */
            height: auto;
            display: block;            
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out; /* Apply transition to filter for smooth effect */
        }
        .state-icon:hover {
            transform: translateY(-5px) scale(1.1); /* Lift and slightly enlarge */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.25)); /* Use CSS drop-shadow for non-rectangular shapes */
        }
        .state-icon.expanded { /* Styles for the expanded state */
            transform: translateY(-5px) scale(1.15); /* Keep it lifted and make it even larger */
            filter: drop-shadow(0 8px 10px rgba(0,0,0,0.3)); /* Stronger shadow for expanded state */
        }
        .region-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            border: 1px solid #e9e9e9;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .region-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .region-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.4em;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .region-card-stats { display: flex; justify-content: space-between; }
        .region-card-stats .stat-item { text-align: left; }

        /* --- New State Stats Panel --- */
        .state-stats-panel {
            background: #fff;
            border-radius: 12px;
            padding: 25px 40px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-top: 40px; /* Space between icons and panel */
            text-align: left;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #e9e9e9;
            animation: slideDownFadeIn 0.4s ease-out;
            transition: opacity 0.4s ease-out; /* For fade-out effect */
        }
        .state-stats-panel h3 {
            margin: 0 0 20px 0;
            font-size: 1.8em;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .state-stats-panel .stats-container {
            display: flex;
            justify-content: space-around; /* Evenly space the stats */
        }

        @keyframes slideDownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Seasonal Heatmap Styles --- */
        .seasonal-heatmap {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        .heatmap-month {
            aspect-ratio: 1 / 1.5; /* Make blocks taller than they are wide */
            background-color: #ebedf0; /* Default color for placeholder */
            border-radius: 4px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            font-size: 0.8em;
            font-weight: bold;
            color: rgba(0,0,0,0.4);
            border: 1px solid rgba(0,0,0,0.05);
            cursor: default; /* Indicate that the blocks are interactive */
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        .heatmap-month:hover {
            transform: scale(1.05); /* Slightly enlarge on hover */
        }

        /* Color scale for the heatmap (to be applied by JS) */
        .heat-level-0 { background-color: #ebedf0; color: rgba(0,0,0,0.4); }
        .heat-level-1 { background-color: #9be9a8; color: rgba(0,0,0,0.5); }
        .heat-level-2 { background-color: #40c463; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.2);}
        .heat-level-3 { background-color: #30a14e; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.2);}
        .heat-level-4 { background-color: #216e39; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.2);}
        
        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Align to the right */
            margin-top: 10px;
            gap: 5px;
            font-size: 12px;
            color: #555;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Add style for the count display within heatmap blocks */
        .heatmap-count {
            font-size: 0.9em;
            font-weight: normal;
            color: #555;
        }
        /* --- Style for the count badge within heatmap blocks --- */
        .hike-count-badge {
            position: absolute; /* Position it within the month block */
            top: 5px;          /* Adjust as needed */
            right: 5px;        /* Adjust as needed */
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent dark background */
            color: white;
            font-size: 0.7em;
            padding: 3px 6px;
            border-radius: 10px; /* Rounded corners for the badge */
            font-weight: bold;
            z-index: 1;           /* Ensure it's above other content within the block */
            transition: background-color 0.3s ease; /* Smooth transition for hover effect */
        }

        .heatmap-month:hover .hike-count-badge {
            background-color: rgba(0, 0, 0, 0.8); /* Darker on hover for emphasis */
        }
        /* --- Featured Adventure Section --- */
        .featured-adventure-section {
            display: flex;
            gap: 30px;
            align-items: flex-start; /* Align items to the top for a cleaner look as content expands */
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            border: 1px solid #e9e9e9;
            margin-top: 40px;
        }
        .featured-adventure-visuals {
            flex-shrink: 0;
            width: 40%;
        }
        .featured-adventure-image-container {
            height: 300px; /* Fixed height for consistency */
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .featured-adventure-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image covers the container without distortion */
        }
        .featured-adventure-content {
            flex-grow: 1;
            text-align: left;
        }
        .featured-adventure-content .subtitle {
            font-size: 1em;
            text-transform: uppercase;
            color: #e67e22; /* An adventurous orange color */
            letter-spacing: 1px;
            font-weight: bold;
            margin: 0;
        }
        .featured-adventure-content .title {
            font-size: 2.2em;
            margin: 5px 0 15px 0;
            color: #2c3e50;
        }
        .featured-adventure-content .panel-description {
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
        }
        .featured-trip-hikes-list {
            margin-bottom: 20px;
        }
        .featured-trip-hike-item {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .featured-trip-hike-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .featured-trip-hike-item h4 {
            margin: 0 0 5px 0;
            font-size: 1.2em;
            color: #333;
        }
        .featured-trip-hike-item .hike-meta {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }
        .featured-trip-hike-item .hike-description {
            font-size: 1em;
            line-height: 1.5;
            color: #555;
            margin: 0;
        }

        .featured-adventure-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
        }

    </style>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="map.html">Interactive Map</a>
    </nav>

    <!-- Showcase Map Section -->
    <a href="map.html" class="showcase-map-container" title="Explore the Interactive Map">
        <div id="home-map"></div>
        <div class="hero-title-overlay">
            <h1>The Trailprint Atlas</h1>
        </div>
        <div class="map-overlay">
            <h3>Explore the Atlas</h3>
            <p>(Click to open the interactive map)</p>
        </div>
    </a>

    <div class="container">
        <h2 class="dashboard-title">Key Atlas Stats (<span id="start-year">....</span> - Present)</h2>
        <!-- Combined Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-group stat-group--emphasized">
                <div class="stat-item"><div id="stats-hikes" class="number">--</div><div class="label">Total Hikes</div></div>
                <div class="stat-item"><div id="stats-trails" class="number">--</div><div class="label">Unique Trails</div></div>
            </div>
            <div class="stat-group stat-group--emphasized">
                <div class="stat-item"><div id="stats-miles" class="number">--</div><div class="label">Miles Hiked</div></div>
                <div class="stat-item"><div id="stats-elevation" class="number">--</div><div class="label">Feet Climbed</div></div>
            </div>
            <div class="stat-group">
                <div class="stat-item"><div id="first-hike-date" class="date-number">--</div><div class="label">First Hike</div><div id="first-hike-name" class="sub-label"></div></div>
                <div class="stat-item"><div id="most-recent-hike-date" class="date-number">--</div><div class="label">Latest Hike</div><div id="most-recent-hike-name" class="sub-label"></div></div>
            </div>
        </div>

        <!-- NEW: Personal Records Section -->
        <div class="personal-records-section">
            <h2 class="dashboard-title">Atlas Achievements</h2>
            <div class="stats-dashboard">
                <!-- Record Card 1: Longest Haul -->
                <div class="record-card">
                    <div id="record-longest-miles" class="number">--</div>
                    <div class="label">Longest Hike</div>
                    <div id="record-longest-miles-name" class="sub-label"></div>
                </div>

                <!-- Record Card 2: Biggest Climb -->
                <div class="record-card">
                    <div id="record-biggest-climb" class="number">--</div>
                    <div class="label">Biggest Climb</div>
                    <div id="record-biggest-climb-name" class="sub-label"></div>
                </div>

                <!-- Record Card 3: Highest Summit -->
                <div class="record-card">
                    <div id="record-highest-summit" class="number">--</div>
                    <div class="label">Highest Summit</div>
                    <div id="record-highest-summit-name" class="sub-label"></div>
                </div>

                <!-- Record Card 4: Busiest Month -->
                <div class="record-card">
                    <div id="record-busiest-month" class="number">--</div>
                    <div class="label">Busiest Month</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="dashboard-title">My Trailprint by State</h2>  <!-- Updated title -->
        <div class="state-icon-grid" id="state-icon-grid">  <!-- Updated ID -->
            <!-- State icons will be injected here by JS -->  <!-- Updated comment -->
        </div>
        <!-- New panel for displaying state stats. It's hidden by default. -->
        <div id="state-stats-panel" class="state-stats-panel" style="display: none;">
            <!-- Content will be injected here by our new JavaScript logic -->
        </div>
    </div>

    <!-- NEW: Seasonal Snapshot Section -->
    <div class="container">
        <h2 class="dashboard-title">Seasonal Snapshot</h2>
        <div class="seasonal-heatmap" id="seasonal-heatmap">
            <!-- These divs are placeholders and will be updated by JavaScript -->
            <div class="heatmap-month">Jan</div>
            <div class="heatmap-month">Feb</div>
            <div class="heatmap-month">Mar</div>
            <div class="heatmap-month">Apr</div>
            <div class="heatmap-month">May</div>
            <div class="heatmap-month">Jun</div>
            <div class="heatmap-month">Jul</div>
            <div class="heatmap-month">Aug</div>
            <div class="heatmap-month">Sep</div>
            <div class="heatmap-month">Oct</div>
            <div class="heatmap-month">Nov</div>
            <div class="heatmap-month">Dec</div>
        </div>
        <div class="heatmap-legend">
            <span class="legend-label">Less</span>
            <span class="legend-color-box heat-level-0"></span>
            <span class="legend-color-box heat-level-1"></span>
            <span class="legend-color-box heat-level-2"></span>
            <span class="legend-color-box heat-level-3"></span>
            <span class="legend-color-box heat-level-4"></span>
            <span class="legend-label">More</span>
        </div>
    </div>

    <div class="container">
        <!-- Featured Adventure Section -->
        <div class="featured-adventure-section" id="featured-adventure" style="display: none;">
            <div class="featured-adventure-visuals">
                <div class="featured-adventure-image-container">
                    <!-- Image will be set by JS -->
                    <img id="featured-trip-image" src="" alt="Photo from the latest adventure">
                </div>
                <div class="featured-adventure-stats">
                    <div class="stat-item" id="featured-trip-days-stat"></div>
                    <div class="stat-item" id="featured-trip-miles-stat"></div>
                    <div class="stat-item" id="featured-trip-elevation-stat"></div>
                </div>
            </div>
            <div class="featured-adventure-content">
                <h3 class="subtitle">My Latest Adventure</h3>
                <h2 class="title" id="featured-trip-title">--</h2>
                <div class="featured-trip-hikes-list" id="featured-trip-hikes-list"></div>
            </div>
        </div>

        <!-- Go-To Trail Section -->
        <div class="featured-adventure-section" id="goto-trail-section" style="display: none;">
            <div class="featured-adventure-visuals">
                <div class="featured-adventure-image-container">
                    <img id="goto-trail-image" src="" alt="Photo from the go-to trail">
                </div>
                <div class="featured-adventure-stats">
                    <div class="stat-item" id="goto-trail-times-hiked-stat"></div>
                    <div class="stat-item" id="goto-trail-miles-stat"></div>
                    <div class="stat-item" id="goto-trail-elevation-stat"></div>
                </div>
            </div>
            <div class="featured-adventure-content">
                <h3 class="subtitle">The Trail I Can't Get Enough Of</h3>
                <h2 class="title" id="goto-trail-title">--</h2>
                <p class="panel-description" id="goto-trail-description">--</p>
                <div class="featured-trip-hikes-list" id="goto-trail-dates-list"></div>
            </div>
        </div>
        <!-- You can add more homepage content here later -->
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>

   <!-- Leaflet-GPX Plugin -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

   <!-- Our new shared trail renderer -->
   <script src="scripts/trail-renderer.js"></script>

   <!-- Custom script for the homepage map -->
   <script>
        // --- Simplified Map for Homepage ---

        // 1. Initialize a non-interactive map
        const homeMap = L.map('home-map', {
            zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false,
            touchZoom: false, boxZoom: false, keyboard: false, tap: false
        });

        // 2. Add the same beautiful base layer
        // We're using CartoDB's "Dark Matter" theme. It's visually stunning, makes the trails pop,
        // and completely eliminates the distracting tile seams for a clean, professional look.
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(homeMap);

        // 4. Fetch hike data and render only the GPX trails
        fetch('data/hikes.json')
            .then(response => response.json())
            .then(data => {
                // Group hikes by trail name, so we only draw each trail once
                const trailGroups = {};
                data.forEach(hike => {
                    if (!trailGroups[hike.trail_name]) trailGroups[hike.trail_name] = [];
                    trailGroups[hike.trail_name].push(hike);
                });

                const allLayersGroup = L.featureGroup().addTo(homeMap);

                Object.values(trailGroups).forEach(group => {
                    // Use the shared renderer in non-interactive mode
                    const layer = renderTrailGroup(group, { isInteractive: false });
                    if (layer) {
                        allLayersGroup.addLayer(layer);
                    }
                });

                // 5. Animate the map layers
                const layersToAnimate = allLayersGroup.getLayers();

                if (layersToAnimate.length === 0) {
                    homeMap.setView([39.82, -98.58], 4); // Fallback
                } else {
                    homeMap.fitBounds(allLayersGroup.getBounds().pad(0.1));

                    layersToAnimate.forEach((layer, index) => {
                        setTimeout(() => {
                            layer.eachLayer(feature => { // feature is always a CircleMarker
                                const finalOpacity = feature.options.className.includes('breathing-halo') ? 0.5 : 0.9;
                                feature.setStyle({ fillOpacity: finalOpacity });
                            });
                        }, index * 75); // Slow down the animation by 50% for a more majestic feel
                    });
                }

                // --- Calculate and Display Stats ---
                // This code runs immediately now, no need to wait for a promise
                (function calculateAndDisplayStats() {
                    const uniqueTrails = Object.values(trailGroups);
                    const totalHikes = data.length;
                    const totalUniqueTrails = uniqueTrails.length;
                    const totalMiles = uniqueTrails.reduce((sum, group) => {
                        // Use the miles from the representative hike for each unique trail
                        // The '|| 0' handles cases where miles might be missing.
                        return sum + (group[0].miles || 0);
                    }, 0);
                    const totalElevation = data.reduce((sum, hike) => {
                        return sum + (hike.elevation_gain || 0);
                    }, 0);
                    const highestSummitHike = data
                        .filter(hike => hike.summit_trail && hike.summit_elevation)
                        .reduce((maxHike, currentHike) => {
                            // If maxHike is null or the current hike is higher, it becomes the new max
                            return (!maxHike || currentHike.summit_elevation > maxHike.summit_elevation) ? currentHike : maxHike;
                        }, null); // Start with null to handle cases with no summits

                    // Animate the main stats for a "wow" effect
                    animateCountUp('stats-hikes', totalHikes);
                    animateCountUp('stats-trails', totalUniqueTrails);
                    animateCountUp('stats-miles', Math.round(totalMiles));
                    animateCountUp('stats-elevation', Math.round(totalElevation));

                    // The "Highest Summit" stat has been moved to the "Atlas Achievements" section, so we no longer need to update it here.

                    // --- Calculate and Display Personal Records ---
                    (function calculateAndDisplayRecords() {
                        // 1. Longest Hike (by miles)
                        const longestHike = uniqueTrails.reduce((max, group) => {
                            const trailMiles = group[0].miles || 0;
                            return (max && (max[0].miles || 0) > trailMiles) ? max : group;
                        }, null);
                        if (longestHike) {
                            document.getElementById('record-longest-miles').innerText = `${Math.round(longestHike[0].miles).toLocaleString()} mi`;
                            document.getElementById('record-longest-miles-name').innerText = longestHike[0].trail_name;
                        }

                        // 2. Biggest Climb (by elevation gain)
                        const biggestClimb = uniqueTrails.reduce((max, group) => {
                            const trailElevation = group[0].elevation_gain || 0;
                            return (max && (max[0].elevation_gain || 0) > trailElevation) ? max : group;
                        }, null);
                        if (biggestClimb) {
                            document.getElementById('record-biggest-climb').innerText = `${biggestClimb[0].elevation_gain.toLocaleString()} ft`;
                            document.getElementById('record-biggest-climb-name').innerText = biggestClimb[0].trail_name;
                        }

                        // 3. Highest Summit (by summit elevation)
                        const highestSummitHike = data
                            .filter(hike => hike.summit_trail && hike.summit_elevation)
                            .reduce((maxHike, currentHike) => {
                                return (!maxHike || currentHike.summit_elevation > maxHike.summit_elevation) ? currentHike : maxHike;
                            }, null);
                        if (highestSummitHike) {
                            document.getElementById('record-highest-summit').innerText = `${highestSummitHike.summit_elevation.toLocaleString()} ft`;
                            document.getElementById('record-highest-summit-name').innerText = highestSummitHike.trail_name;
                        } else {
                            document.getElementById('record-highest-summit').innerText = '--';
                            document.getElementById('record-highest-summit-name').innerText = 'No summits recorded';
                        }

                        // 4. Busiest Month (by number of hikes in a single month across all years)
                        const monthlyHikeCounts = data.reduce((counts, hike) => {
                            const date = new Date(hike.date_completed);
                            const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                            counts[monthYear] = (counts[monthYear] || 0) + 1;
                            return counts;
                        }, {});

                        let busiestMonthYear = '';
                        let maxHikesInMonth = 0;

                        for (const [monthYear, hikeCount] of Object.entries(monthlyHikeCounts)) {
                            if (hikeCount > maxHikesInMonth) {
                                maxHikesInMonth = hikeCount;
                                busiestMonthYear = monthYear;
                            }
                        }

                        if (busiestMonthYear) {
                            const [year, month] = busiestMonthYear.split('-');
                            const date = new Date(year, month - 1);
                            const monthName = date.toLocaleDateString('en-US', { month: 'long' });
                            document.getElementById('record-busiest-month').innerText = `${monthName} ${year} (${maxHikesInMonth} hikes)`;
                        } else {
                            document.getElementById('record-busiest-month').innerText = '--';
                        }
                    })();


                    // --- Recalculate Map Bounds Now That All Trail Data is Loaded ---
                    if (layersToAnimate.length === 0) {
                        homeMap.setView([39.82, -98.58], 4); // Fallback
                    } else {
                        const allLayersGroup = L.featureGroup();
                        layersToAnimate.forEach(layer => allLayersGroup.addLayer(layer));
                        homeMap.fitBounds(allLayersGroup.getBounds().pad(0.1));

                        layersToAnimate.forEach((layer, index) => {
                            setTimeout(() => {
                                layer.eachLayer(feature => {
                                    const finalOpacity = feature.options.className.includes('breathing-halo') ? 0.5 : 0.9;
                                    feature.setStyle({ fillOpacity: finalOpacity });
                                });
                            }, index * 75);
                        });
                    }
                    // --- Calculate and Display Time Range ---
                    if (data.length > 0) {
                        // Find the earliest year in the dataset
                        const startYear = data.reduce((min, hike) => {
                            const year = new Date(hike.date_completed).getFullYear();
                            return year < min ? year : min;
                        }, new Date().getFullYear()); // Start with the current year as the initial minimum
                        document.getElementById('start-year').innerText = startYear;
                    }

                    // --- Calculate and Display First/Most Recent Hikes ---
                    if (data.length > 0) {
                        const sortedHikes = [...data].sort((a, b) => new Date(a.date_completed) - new Date(b.date_completed));
                        const firstHike = sortedHikes[0];
                        const mostRecentHike = sortedHikes[sortedHikes.length - 1];
                        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };

                        document.getElementById('first-hike-date').innerText = new Date(firstHike.date_completed).toLocaleDateString('en-US', dateOptions);
                        document.getElementById('first-hike-name').innerText = `${firstHike.trail_name} - ${firstHike.location}`;

                        document.getElementById('most-recent-hike-date').innerText = new Date(mostRecentHike.date_completed).toLocaleDateString('en-US', dateOptions);
                        document.getElementById('most-recent-hike-name').innerText = `${mostRecentHike.trail_name} - ${mostRecentHike.location}`;
                    } else {
                        document.getElementById('first-hike-date').innerText = '--';
                        document.getElementById('most-recent-hike-date').innerText = '--';
                    }
                    
                    // --- Find and Display Featured Adventure ---
                    const hikesWithTripTag = data.filter(hike => hike.trip_tag);

                    if (hikesWithTripTag.length > 0) {
                        // Find the most recent hike that is part of any trip
                        const latestTripHike = hikesWithTripTag.sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))[0];
                        const latestTripTag = latestTripHike.trip_tag;

                        // Now, gather all hikes associated with that specific trip
                        const adventureHikes = data.filter(h => h.trip_tag === latestTripTag);
                        
                        // Find the latest hike within that trip to pull the description and image from
                        const latestHikeInTrip = adventureHikes.sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))[0];

                        // Populate the title
                        document.getElementById('featured-trip-title').innerText = latestTripTag;

                        // Populate the list of hikes for the trip
                        const hikesListContainer = document.getElementById('featured-trip-hikes-list');
                        hikesListContainer.innerHTML = ''; // Clear previous content
                        adventureHikes
                            .sort((a, b) => new Date(a.date_completed) - new Date(b.date_completed)) // Sort chronologically
                            .forEach(hike => {
                                const hikeItemHtml = `
                                    <div class="featured-trip-hike-item">
                                        <h4>${hike.trail_name}</h4>
                                        <div class="hike-meta">${hike.miles} miles | ${hike.elevation_gain.toLocaleString()} ft gain</div>
                                        <p class="hike-description">${hike.description}</p>
                                    </div>
                                `;
                                hikesListContainer.innerHTML += hikeItemHtml;
                            });

                        // Calculate stats for the featured adventure
                        const tripMiles = adventureHikes.reduce((sum, h) => sum + (h.miles || 0), 0);
                        const tripElevation = adventureHikes.reduce((sum, h) => sum + (h.elevation_gain || 0), 0);
                        const tripDays = new Set(adventureHikes.map(h => h.date_completed)).size; // Count unique days
                        
                        // Populate the summary stats at the bottom with clearer labels
                        document.getElementById('featured-trip-days-stat').innerHTML = `<span class="number">${tripDays}</span><span class="label">Trip Day${tripDays !== 1 ? 's' : ''}</span>`;
                        document.getElementById('featured-trip-miles-stat').innerHTML = `<span class="number">${Math.round(tripMiles)}</span><span class="label">Total Miles</span>`;
                        document.getElementById('featured-trip-elevation-stat').innerHTML = `<span class="number">${tripElevation.toLocaleString()}</span><span class="label">Total Gain (ft)</span>`;

                        // TODO: Add an image path to your hikes.json for this to work! e.g., "images": ["path/to/image.jpg"]
                        // document.getElementById('featured-trip-image').src = latestHikeInTrip.images[0] || 'path/to/default-image.jpg';
                        document.getElementById('featured-adventure').style.display = 'flex';
                    }

                    // --- Find and Display the "Go-To" (Most Hiked) Trail ---
                    const trailCounts = {};
                    data.forEach(hike => {
                        if (hike.trail_name) { // Ensure trail_name exists
                            trailCounts[hike.trail_name] = (trailCounts[hike.trail_name] || 0) + 1;
                        }
                    });

                    let mostHikedTrailName = '';
                    let maxHikes = 1; // Only feature trails hiked more than once
                    for (const trailName in trailCounts) {
                        if (trailCounts[trailName] > maxHikes) {
                            maxHikes = trailCounts[trailName];
                            mostHikedTrailName = trailName;
                        }
                    }

                    if (mostHikedTrailName) {
                        const mostHikedHikes = data.filter(h => h.trail_name === mostHikedTrailName);
                        const representativeHike = mostHikedHikes.sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))[0];

                        const totalMiles = mostHikedHikes.reduce((sum, h) => sum + (h.miles || 0), 0);
                        const totalElevation = mostHikedHikes.reduce((sum, h) => sum + (h.elevation_gain || 0), 0);

                        document.getElementById('goto-trail-title').innerText = representativeHike.trail_name;
                        document.getElementById('goto-trail-description').innerText = representativeHike.description;

                        const datesHtml = mostHikedHikes
                            .sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))
                            .map(h => `<li>${new Date(h.date_completed).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}</li>`)
                            .join('');
                        document.getElementById('goto-trail-dates-list').innerHTML = `<h4>Dates Hiked:</h4><ul>${datesHtml}</ul>`;

                        document.getElementById('goto-trail-times-hiked-stat').innerHTML = `<span class="number">${maxHikes}</span><span class="label">Times Hiked</span>`;
                        document.getElementById('goto-trail-miles-stat').innerHTML = `<span class="number">${Math.round(totalMiles)}</span><span class="label">Total Miles</span>`;
                        document.getElementById('goto-trail-elevation-stat').innerHTML = `<span class="number">${totalElevation.toLocaleString()}</span><span class="label">Total Gain (ft)</span>`;
                        document.getElementById('goto-trail-section').style.display = 'flex';
                    }

                    // --- Create Region Spotlight ---
                    (function createStateIconGrid() { // Renamed for clarity
                        const states = {};

                        Object.values(trailGroups).forEach(group => {
                            const representativeHike = group[0];
                            // Extract the state abbreviation from the region string
                            const state = representativeHike.region ? representativeHike.region.split(", ").pop() : "Unknown";

                            if (!states[state]) {
                                states[state] = {
                                    uniqueTrails: 0,
                                    totalHikes: 0,
                                    totalMiles: 0,
                                    iconPath: `assets/state-icons/${state}.svg` // Construct icon path
                                };
                            }

                            states[state].uniqueTrails++;
                            states[state].totalHikes += group.length;                            
                            states[state].totalMiles += representativeHike.miles || 0;
                        });

                        const container = document.getElementById('state-icon-grid'); // New container ID
                        if (!container) return;
                        container.innerHTML = '';

                        // Create state icon elements
                        Object.entries(states).forEach(([state, stats]) => {
                            const cardHtml = `
                                <div class="state-icon-container">
                                    <img 
                                        src="${stats.iconPath}" 
                                        alt="${state} icon" 
                                        class="state-icon" 
                                        id="state-icon-${state}"
                                        data-state="${state}"
                                        data-unique-trails="${stats.uniqueTrails}"
                                        data-total-hikes="${stats.totalHikes}"
                                        data-total-miles="${stats.totalMiles < 0.1 ? '<0.1' : Math.round(stats.totalMiles)}"
                                    >
                                    </div>
                                </div>`;
                            container.innerHTML += cardHtml; // Append the card HTML to the container
                        });
                    })();


                    // --- NEW: State Icon Interactivity ---
                    // This IIFE sets up the click-to-show-stats functionality.
                    (function setupStateIconInteractivity() {
                        const stateIconGrid = document.getElementById('state-icon-grid');
                        const stateStatsPanel = document.getElementById('state-stats-panel');
                        if (!stateIconGrid || !stateStatsPanel) return; // Exit if elements don't exist

                        // --- State Name Mapping ---
                        const stateNames = {
                            "CA": "California", "AZ": "Arizona" // Add more state mappings as needed
                        };

                        const getStateName = (abbreviation) => {
                            return stateNames[abbreviation] || abbreviation; // Return full name or abbreviation if not found
                        };

                        // --- Update Panel Title ---
                        const updatePanelTitle = (stateAbbr) => {
                            const stateFullName = getStateName(stateAbbr);
                            return `${stateFullName} Hike Stats`;
                        };

                        let currentlyExpandedIcon = null; // Variable to track which icon is open

                        // Use event delegation for efficiency
                        stateIconGrid.addEventListener('click', (event) => {
                            const clickedIcon = event.target.closest('.state-icon');
                            if (!clickedIcon) return; // If the click wasn't on an icon, do nothing

                            const wasExpanded = clickedIcon.classList.contains('expanded');

                            // First, close any icon that is already open
                            if (currentlyExpandedIcon && currentlyExpandedIcon !== clickedIcon) {
                                currentlyExpandedIcon.classList.remove('expanded');
                            }

                            // Toggle the 'expanded' class on the clicked icon
                            clickedIcon.classList.toggle('expanded');

                            if (!wasExpanded) {
                                // If it wasn't expanded before, we now open it.
                                const { state, uniqueTrails, totalHikes, totalMiles } = clickedIcon.dataset;

                                // Populate the panel with this state's data
                                stateStatsPanel.innerHTML = `                                    
                                    <h3>${state} Trailprint Stats</h3>
                                    <div class="stats-container">
                                        <div class="stat-item"><span class="number">${totalHikes}</span><span class="label">Total Hikes</span></div>
                                        <div class="stat-item"><span class="number">${uniqueTrails}</span><span class="label">Unique Trails</span></div>
                                        <div class="stat-item"><span class="number">${totalMiles}</span><span class="label">Miles Hiked</span></div>
                                    </div>
                                `;
                                stateStatsPanel.querySelector('h3').innerText = updatePanelTitle(state);
                                stateStatsPanel.style.display = 'block'; // Make the panel visible
                                currentlyExpandedIcon = clickedIcon; // Set this as the currently open icon
                            } else {
                                stateStatsPanel.style.opacity = 0; // Start fade-out
                                setTimeout(() => { stateStatsPanel.style.display = 'none'; stateStatsPanel.style.opacity = 1; }, 400); // Hide after animation
                                currentlyExpandedIcon = null; // Clear the currently expanded icon
                            }
                        });

                        // Add a click listener to the whole document to close the panel if the user clicks away
                        document.addEventListener('click', (event) => {
                            if (!stateIconGrid.contains(event.target) && !stateStatsPanel.contains(event.target) && currentlyExpandedIcon) {
                                currentlyExpandedIcon.classList.remove('expanded');
                                stateStatsPanel.style.display = 'none';
                                currentlyExpandedIcon = null;
                            }
                        });
                    })();

                    // --- NEW: Create Seasonal Heatmap ---
                    (function createSeasonalHeatmap() {
                        const heatmapContainer = document.getElementById('seasonal-heatmap');
                        if (!heatmapContainer) return; // Exit if the container isn't on the page

                        // 1. Tally hikes per month (0-11 index for Jan-Dec)
                        const monthCounts = Array(12).fill(0);
                        data.forEach(hike => {
                            // Use getUTCMonth to avoid timezone issues with simple 'YYYY-MM-DD' dates
                            const month = new Date(hike.date_completed).getUTCMonth();
                            monthCounts[month]++;
                        });

                        // 2. Define a function to get the heat level based on hike count
                        const getHeatLevel = (count) => {
                            if (count === 0) return 0;
                            if (count >= 10) return 4; // Heaviest
                            if (count >= 6) return 3;
                            if (count >= 3) return 2;
                            return 1; // Lightest, but not zero
                        };

                        const monthAbbreviations = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        // 3. Clear placeholders and generate the HTML for each month block
                        heatmapContainer.innerHTML = '';
                        monthAbbreviations.forEach((abbr, index) => {
                            const count = monthCounts[index];
                            const heatLevel = getHeatLevel(count);
                            const tooltipText = `${abbr}: ${count} hike${count !== 1 ? 's' : ''}`;
                            // Display the count within a visually distinct container
                            const displayText = `${abbr}<div class="hike-count-badge">${count} (Total)</div>`;
                            heatmapContainer.innerHTML += `
                                <div class="heatmap-month heat-level-${heatLevel}">${displayText}</div>`;                        });
                    })();
                })();
            }).catch(error => {
                console.error("Error loading homepage map data:", error);
                homeMap.setView([39.82, -98.58], 4);
            });

        // --- Helper function for the count-up animation ---
        function animateCountUp(elementId, finalValue, duration = 2000) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = Math.floor(progress * finalValue);
                element.innerText = currentValue.toLocaleString();

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
   </script>
</body>
</html>