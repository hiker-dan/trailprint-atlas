<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trailprint Atlas</title>
    <!-- Add Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        body { 
            margin: 0; 
            font-family: sans-serif; 
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            font-size: 2.5em;
        }
        /* --- Navigation Bar --- */
        nav {
            background-color: #333;
            padding: 10px 20px;
            text-align: center;
        }
        nav a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-weight: bold;
        }
        nav a:hover {
            text-decoration: underline;
        }
        /* Style for our custom hike icons (for viewpoints) */
        .hike-icon {
            /* This creates a circular, semi-transparent white "puck" behind the icon to make it pop. */
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%; /* This makes the background circular */
            /* This adds a subtle dark outline to the white circle, helping it stand out on light backgrounds. */
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
        }
        /* --- Showcase Map Styles --- */
        .showcase-map-container {
            position: relative;
            height: 60vh; /* Make the hero map taller */
            cursor: pointer;
            overflow: hidden; /* Hide anything that might stick out */
            display: block; /* Ensures the link takes up the full container space */
        }
        .hero-title-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensures the title is on top of the map tiles */
        }
        #home-map {
            height: 100%;
            width: 100%;
            background-color: #1d1d1d; /* Dark background to hide satellite tile seams */
        }
        /* Keyframe animation for the "breathing" glow effect */
        @keyframes breathing-glow {
            0% { opacity: 0.4; }
            50% { opacity: 0.7; }
            100% { opacity: 0.4; }
        }
        /* Class to apply the animation to our halo layers */
        .breathing-halo {
            /* ease-in-out makes the pulse smooth */
            animation: breathing-glow 4s ease-in-out infinite;
        }
        /* Add a smooth transition for the trail fade-in effect */
        .leaflet-path.trail-path {
            transition: opacity 1.5s ease-in, fill-opacity 1.5s ease-in;
        }
        .map-overlay {
            /* This ensures the overlay doesn't cover our new stats panel */
            pointer-events: none;
        }
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.2); /* Dark overlay */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .showcase-map-container:hover .map-overlay {
            opacity: 1;
        }
        .map-overlay h3 {
            margin: 0;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        .map-overlay p {
            margin-top: 10px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .hero-title-overlay h1 {
            font-size: 4.5em;
            color: rgba(255, 255, 255, 0.50); /* Make the title slightly transparent to let the map shine through */
            margin: 0;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.8);
            pointer-events: none; /* Make sure title doesn't block the link */
        }
        .container {
            max-width: 900px; /* Widen container for more space */
            margin: 40px auto;
            padding: 20px;
            text-align: center;
            /* Add some structure and background to the dashboard area */
            background-color: #f9f9f9; /* A light gray */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* Very subtle shadow */
            padding: 40px 20px; /* Increase padding */
            max-width: 1000px; /* Allow it to stretch a bit more */
        }
        /* --- Stats Panel Styles --- */
        .stats-dashboard {
            display: flex;
            justify-content: center; /* Center the groups */
            gap: 20px; /* Space between the stat "bubbles" */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            margin: 30px auto 0 auto; /* Spacing for above and below the map */
        }
        .stat-group {
            display: flex; /* Aligns stat items within a group */
            align-items: center;
            padding: 15px 30px;
            /* Style each group as a "bubble" or card */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            border: 1px solid #e9e9e9;
        }
        /* New rule to add a divider between stat items */
        .stat-group > .stat-item + .stat-item {
            padding-left: 30px;
            margin-left: 30px;
            border-left: 1px solid #eee;
        }
        .stat-group--emphasized {
            /* A darker, more premium "bubble" to make these stats pop */
            background-color: #2c3e50; /* Dark blue-gray */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            padding: 25px 40px;
            transform: translateY(-5px); /* Slightly lift the element */
        }
        .stat-group--emphasized .stat-item .number {
            font-size: 2.4em; /* Larger font for the numbers */
            color: #f1c40f; /* A striking gold color that pops on the dark background */
        }
        .stat-group--emphasized .stat-item .label {
            color: #bdc3c7; /* A light gray for readability on the dark background */
        }
        /* Remove the divider for emphasized stats since they are in separate bubbles */
        .stat-group--emphasized > .stat-item + .stat-item { border-left: none; }
        
        .personal-records-section {
            margin-top: 60px; /* Add more space between the key stats and achievements */
        }
        .record-card {
            background-color: #fff;
            border: 1px solid #e9e9e9;
            border-left: 5px solid #4a7c59; /* A natural green accent */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 25px;
            position: relative; /* For icon positioning */
            padding-left: 80px; /* Make more space for the icon */
            flex: 1 1 45%; /* Use a percentage-based flex-basis to ensure two cards fit per row */
            text-align: left; /* Align text to the left for a more formal look */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box; /* This is the key fix: it includes padding/border in the element's total width */
        }
        .record-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        /* A simple placeholder icon for each card */
        .record-card::before {
            font-size: 2.5em; /* Make icons a bit larger */
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #4a7c59;
            opacity: 0.7;
        }
        /* Custom icons for each record using emojis */
        .record-card:nth-of-type(1)::before { content: 'üìè'; } /* Ruler for longest hike */
        .record-card:nth-of-type(2)::before { content: 'üßó'; } /* Climber for biggest climb */
        .record-card:nth-of-type(3)::before { content: 'üèîÔ∏è'; } /* Mountain for highest summit */
        .record-card:nth-of-type(4)::before { content: 'üóìÔ∏è'; } /* Calendar for busiest month */

        /* Custom styles for text inside record cards */
        .record-card .number { font-size: 2.2em; }
        .record-card .label {
            color: #333; /* Slightly darker label for better contrast */
        }
        .record-card .sub-label {
            font-style: italic; /* Differentiate the hike name from the main label */
            color: #666;
        }

        .stat-item {
            text-align: center;
            color: #555;
        }
        .stat-item .number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50; /* A strong, dark blue/gray */
            display: block;
            margin-bottom: 5px;
        }
        .stat-item .date-number {
            font-size: 1.4em; /* Slightly smaller for date strings */
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        .stat-item .label {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sub-label {
            font-size: 1em; /* Make it slightly more prominent */
            color: #777;
            margin-top: 4px;
        }
        .dashboard-title { 
            font-size: 2.2em; /* Make title bigger to match emphasized stats */
            font-weight: 600;
            color: #333;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0; 
        }
        /* --- Region Spotlight Section --- */
        .state-icon-grid { /* Renamed class */
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap onto the next line on smaller screens */
            justify-content: center; /* This is the key: it centers the items horizontally */
            gap: 50px;
            margin-top: 30px;
        }
        
        .state-icon { /* Style the icons directly */
            width: 260px; /* Size */
            height: auto;
            display: block;            
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out; /* Apply transition to filter for smooth effect */
        }
        .state-icon:hover {
            transform: translateY(-5px) scale(1.1); /* Lift and slightly enlarge */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.25)); /* Use CSS drop-shadow for non-rectangular shapes */
        }
        .state-icon.expanded { /* Styles for the expanded state */
            transform: translateY(-5px) scale(1.15); /* Keep it lifted and make it even larger */
            filter: drop-shadow(0 8px 10px rgba(0,0,0,0.3)); /* Stronger shadow for expanded state */
        }
        .region-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            border: 1px solid #e9e9e9;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .region-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .region-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.4em;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .region-card-stats { display: flex; justify-content: space-between; }
        .region-card-stats .stat-item { text-align: left; }

        /* --- New State Stats Panel --- */
        .state-stats-panel {
            background: #fff;
            border-radius: 12px;
            padding: 25px 40px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-top: 40px; /* Space between icons and panel */
            text-align: left;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #e9e9e9;
            animation: slideDownFadeIn 0.4s ease-out;
            transition: opacity 0.4s ease-out; /* For fade-out effect */
        }
        .state-stats-panel h3 {
            margin: 0 0 20px 0;
            font-size: 1.8em;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .state-stats-panel .stats-container {
            display: flex;
            justify-content: space-around; /* Evenly space the stats */
        }

        @keyframes slideDownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Seasonal Heatmap Styles --- */
        .seasonal-heatmap {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        .heatmap-month {
            aspect-ratio: 1 / 1.5; /* Make blocks taller than they are wide */
            background-color: #ebedf0; /* Default color for placeholder */
            border-radius: 4px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            font-size: 0.8em;
            font-weight: bold;
            color: rgba(0,0,0,0.4);
            border: 1px solid rgba(0,0,0,0.05);
            cursor: default; /* Indicate that the blocks are interactive */
            position: relative; /* This is the key fix: it contains the absolutely positioned badge */
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        .heatmap-month:hover {
            transform: scale(1.05); /* Slightly enlarge on hover */
        }

        /* Color scale for the heatmap (to be applied by JS) */
        .heat-level-0 { background-color: #f0eee9; color: #5d5d5d; } /* Off-white */
        .heat-level-1 { background-color: #e0dcd5; color: #5d5d5d; } /* Very light beige */
        .heat-level-2 { background-color: #c1b6ab; color: #5d5d5d; } /* Light beige */
        .heat-level-3 { background-color: #a29181; color: white; } /* Medium beige */
        .heat-level-4 { background-color: #836c57; color: white; } /* Dark beige */
        .heat-level-5 { background-color: #64472d; color: white; } /* Darker brown */
        .heat-level-6 { background-color: #452203; color: white; } /* Deep brown */
        

        /* You can add text-shadow to higher levels for readability if needed */
        .heat-level-4, .heat-level-5, .heat-level-6 {
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);
        }

        .heatmap-legend {
             display: flex;
            align-items: center;
            justify-content: flex-end; /* Align to the right */
            margin-top: 10px;
            gap: 5px;
            font-size: 12px;
            color: #555;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Subtitle for the heatmap legend */
        .legend-subtitle {
            font-style: italic;
            font-weight: normal;
            margin: 0; /* Reset default paragraph margins to fit in the flex container */
        }

        /* Add style for the count display within heatmap blocks */
        .heatmap-count {
            font-size: 0.9em;
            font-weight: normal;
            color: #555;
        }
        /* --- Style for the count badge within heatmap blocks --- */
        .hike-count-badge {
            position: absolute; /* Position it within the month block */
            top: 5px;          /* Adjust as needed */
            right: 5px;        /* Adjust as needed */
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent dark background */
            color: white;
            font-size: 0.7em;
            padding: 3px 6px;
            border-radius: 10px; /* Rounded corners for the badge */
            font-weight: bold;
            z-index: 1;           /* Ensure it's above other content within the block */
            transition: background-color 0.3s ease; /* Smooth transition for hover effect */
        }

        .heatmap-month:hover .hike-count-badge {
            background-color: rgba(0, 0, 0, 0.8); /* Darker on hover for emphasis */
        }
        /* --- Animated Title for "Field Notes" --- */
        .field-notes-title {
            /* The magic for the animated gradient text */
            background: linear-gradient(90deg, #4a7c59, #6a994e, #4a7c59, #6a994e);
            background-size: 200% auto;
            color: #000;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-flow 4s linear infinite;

            /* Keep the bottom border, but give it more space */
            padding-bottom: 20px;
            margin-bottom: 25px; /* Increased margin to push the strapline down */
        }
        @keyframes gradient-flow {
            to { background-position: -200% center; }
        }
        /* --- Unified "Field Notes" Section --- */
        .live-journal-section {
            background-color: #f9f9f9; /* A slightly off-white to unify the components */
            border: 1px solid #e9e9e9;
            padding: 40px;
            border-radius: 12px;
        }

        /* --- Trail Log Section ("From the Field") --- */
        .trail-log-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
            gap: 20px;
            margin-top: 40px;
            text-align: left; /* Override container's center alignment */
        }

        /* Specific styling for the subtitle directly within the live journal section */
        .live-journal-section > .subtitle {
            text-align: left;
            margin-top: 40px;
        }

        .section-strapline {
            font-size: 1.1em;
            color: #666;
            margin-top: 0; /* Removed negative margin to create space */
            margin-bottom: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .trail-log-card {
            background-color: #fff;
            border: 1px solid #e9e9e9;
            border-top: 4px solid #4a7c59; /* Accent color on top */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 160px; /* Ensure cards have a consistent height */
        }

        .trail-log-card::before {
            content: none; /* Remove the large side number for a cleaner look */
        }

        .trail-log-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        
        .trail-log-card h4 {
            margin: 0 0 8px 0;
            font-size: 1.2em; /* Slightly larger title */
            color: #2c3e50;
            line-height: 1.3;
        }

        .trail-log-card .location-date {
            margin: 0;
            font-size: 0.9em;
            color: #777;
            margin-bottom: 15px;
        }

        .trail-log-stats {
            display: flex;
            gap: 25px; /* More space between stats */
            margin-top: auto; /* Pushes stats to the bottom of the card */
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .trail-log-stats .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trail-log-stats .stat-icon {
            font-size: 1.2em;
            color: #4a7c59;
        }

        .trail-log-stats .stat-value {
            font-weight: 600;
            color: #333;
        }
        /* --- Featured Adventure Section --- */
        .featured-adventure-section {
            display: flex;
            gap: 30px;
            align-items: flex-start; /* Align items to the top for a cleaner look as content expands */
            padding: 30px;
            margin-top: 40px;
            border-top: 1px solid #eee; /* Use a subtle separator line */
        }
        .featured-adventure-visuals {
            flex-shrink: 0;
            width: 40%;
        }
        .featured-adventure-image-container {
            position: relative; /* Crucial for layering the slideshow images */
            height: 300px; /* Fixed height for consistency */
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            background-color: #e9e9e9; /* A neutral background color */
        }
        /* NEW: Styles for the slideshow images */
        .featured-adventure-image-container .slideshow-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image covers the container without distortion */
            opacity: 0;
            transition: opacity 1.5s ease-in-out; /* A slow, graceful fade */
        }
        .featured-adventure-image-container .slideshow-image.active {
            opacity: 1;
        }
        .featured-adventure-content {
            flex-grow: 1;
            text-align: left;
        }
        .featured-adventure-content .subtitle {
            font-size: 1em;
            text-transform: uppercase;
            color: #4a7c59; /* A natural green color */
            letter-spacing: 1px;
            font-weight: bold;
            margin: 0;
        }
        .featured-adventure-content .title {
            font-size: 2.2em;
            margin: 5px 0 15px 0;
            color: #2c3e50;
        }
        .featured-adventure-content .panel-description {
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
        }
        .featured-trip-hikes-list {
            margin-bottom: 20px;
        }
        .featured-trip-hike-item {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .featured-trip-hike-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .featured-trip-hike-item h4 {
            margin: 0 0 5px 0;
            font-size: 1.2em;
            color: #333;
        }
        .featured-trip-hike-item .hike-meta {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }
        .featured-trip-hike-item .hike-description {
            font-size: 1em;
            line-height: 1.5;
            color: #555;
            margin: 0;
        }

        .featured-adventure-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
        }

    </style>
    <link rel="stylesheet" href="styles/map-stats.css"/>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="map.html">Interactive Map</a>
        <a href="#" id="latest-hike-link">Latest Hike</a>
        <a href="credits.html">The Overlook</a>
    </nav>

    <!-- Showcase Map Section -->
    <a href="map.html" class="showcase-map-container" title="Explore the Interactive Map">
        <div id="home-map"></div>
        <div class="hero-title-overlay">
            <h1>The Trailprint Atlas</h1>
        </div>
        <div class="map-overlay">
            <h3>Explore the Atlas</h3>
            <p>(Click to open the interactive map)</p>
        </div>
    </a>

    <div class="container">
        <h2 class="dashboard-title">Key Atlas Stats (<span id="start-year">....</span> - Present)</h2>
        <!-- Combined Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-group stat-group--emphasized">
                <div class="stat-item"><div id="stats-hikes" class="number">--</div><div class="label">Total Hikes</div></div>
                <div class="stat-item"><div id="stats-trails" class="number">--</div><div class="label">Unique Trails</div></div>
            </div>
            <div class="stat-group stat-group--emphasized">
                <div class="stat-item"><div id="stats-miles" class="number">--</div><div class="label">Miles Hiked</div></div>
                <div class="stat-item"><div id="stats-elevation" class="number">--</div><div class="label">Feet Climbed</div></div>
            </div>
            <div class="stat-group">
                <div class="stat-item"><div id="first-hike-date" class="date-number">--</div><div class="label">First Hike</div><div id="first-hike-name" class="sub-label"></div></div>
                <div class="stat-item"><div id="most-recent-hike-date" class="date-number">--</div><div class="label">Latest Hike</div><div id="most-recent-hike-name" class="sub-label"></div></div>
            </div>
        </div>

        <!-- NEW: Personal Records Section -->
        <div class="personal-records-section">
            <h2 class="dashboard-title">Atlas Achievements</h2>
            <div class="stats-dashboard">
                <!-- Record Card 1: Longest Haul -->
                <div class="record-card">
                    <div id="record-longest-miles" class="number">--</div>
                    <div class="label">Longest Hike</div>
                    <div id="record-longest-miles-name" class="sub-label"></div>
                </div>

                <!-- Record Card 2: Biggest Climb -->
                <div class="record-card">
                    <div id="record-biggest-climb" class="number">--</div>
                    <div class="label">Biggest Climb</div>
                    <div id="record-biggest-climb-name" class="sub-label"></div>
                </div>

                <!-- Record Card 3: Highest Summit -->
                <div class="record-card">
                    <div id="record-highest-summit" class="number">--</div>
                    <div class="label">Highest Summit</div>
                    <div id="record-highest-summit-name" class="sub-label"></div>
                </div>

                <!-- Record Card 4: Busiest Month -->
                <div class="record-card">
                    <div id="record-busiest-month" class="number">--</div>
                    <div class="label">Busiest Month</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="dashboard-title">My Trailprint by State</h2>
        <div id="interactive-map-container">
            <!-- SVG will be embedded here -->
        </div>
        <div id="map-tooltip"></div>
    </div>

    <!-- NEW: Seasonal Snapshot Section -->
    <div class="container">
        <h2 class="dashboard-title">Seasonal Snapshot</h2>
        <div class="seasonal-heatmap" id="seasonal-heatmap">
            <!-- These divs are placeholders and will be updated by JavaScript -->
            <div class="heatmap-month">Jan</div>
            <div class="heatmap-month">Feb</div>
            <div class="heatmap-month">Mar</div>
            <div class="heatmap-month">Apr</div>
            <div class="heatmap-month">May</div>
            <div class="heatmap-month">Jun</div>
            <div class="heatmap-month">Jul</div>
            <div class="heatmap-month">Aug</div>
            <div class="heatmap-month">Sep</div>
            <div class="heatmap-month">Oct</div>
            <div class="heatmap-month">Nov</div>
            <div class="heatmap-month">Dec</div>
        </div>
        <div class="heatmap-legend">
            <span class="legend-label">Less</span>
            <span class="legend-color-box heat-level-0"></span>
            <span class="legend-color-box heat-level-1"></span>
            <span class="legend-color-box heat-level-2"></span>
            <span class="legend-color-box heat-level-3"></span>
            <span class="legend-color-box heat-level-4"></span>
            <span class="legend-label">More</span>
            <p class="legend-subtitle">(Total Number of Hikes Per Month)</p>
        </div>
    </div>

    <div class="container live-journal-section">
        <h2 class="dashboard-title field-notes-title">Echoes of the Trail</h2>
        <p class="section-strapline">The living journal of my hiking life, from the latest footprints on the trail to my most significant expeditions and well-worn paths.</p>
        <h3 class="subtitle">Fresh Tracks</h3>
        <div id="trail-log-section" class="trail-log-grid">
            <!-- Recent hikes will be injected here by JS -->
        </div>

        <!-- Featured Adventure Section -->
        <div class="featured-adventure-section" id="featured-adventure" style="display: none;">
            <div class="featured-adventure-visuals">
                <div class="featured-adventure-image-container">
                    <!-- Slideshow images will be injected here by JS -->
                </div>
                <div class="featured-adventure-stats">
                    <div class="stat-item" id="featured-trip-days-stat"></div>
                    <div class="stat-item" id="featured-trip-miles-stat"></div>
                    <div class="stat-item" id="featured-trip-elevation-stat"></div>
                </div>
            </div>
            <div class="featured-adventure-content">
                <h3 class="subtitle">The Grand Traverse</h3>
                <h2 class="title" id="featured-trip-title">--</h2>
                <div class="featured-trip-hikes-list" id="featured-trip-hikes-list"></div>
            </div>
        </div>

        <!-- Go-To Trail Section -->
        <div class="featured-adventure-section" id="goto-trail-section" style="display: none;">
            <div class="featured-adventure-visuals">
                <div class="featured-adventure-image-container">
                    <!-- Slideshow images will be injected here by JS -->
                </div>
                <div class="featured-adventure-stats">
                    <div class="stat-item" id="goto-trail-times-hiked-stat"></div>
                    <div class="stat-item" id="goto-trail-miles-stat"></div>
                    <div class="stat-item" id="goto-trail-elevation-stat"></div>
                </div>
            </div>
            <div class="featured-adventure-content">
                <h3 class="subtitle">The Well-Worn Path</h3>
                <h2 class="title" id="goto-trail-title">--</h2>
                <p class="panel-description" id="goto-trail-description">--</p>
                <div class="featured-trip-hikes-list" id="goto-trail-dates-list"></div>
            </div>
        </div>
        <!-- You can add more homepage content here later -->
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>

   <!-- Leaflet-GPX Plugin -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

   <!-- Our new shared trail renderer -->
   <script src="scripts/trail-renderer.js"></script>

   <!-- Custom script for the homepage map -->
   <script>
        // --- Simplified Map for Homepage ---

        // 1. Initialize a non-interactive map
        const homeMap = L.map('home-map', {
            zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false,
            touchZoom: false, boxZoom: false, keyboard: false, tap: false
        });

        // 2. Add the same beautiful base layer
        // We're using CartoDB's "Dark Matter" theme. It's visually stunning, makes the trails pop,
        // and completely eliminates the distracting tile seams for a clean, professional look.
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(homeMap);

        // 4. Fetch hike data and render only the GPX trails
        fetch('data/hikes.json')
            .then(response => response.json())
            .then(data => {
                // Group hikes by trail name, so we only draw each trail once
                const trailGroups = {};
                data.forEach(hike => {
                    if (!trailGroups[hike.trail_name]) trailGroups[hike.trail_name] = [];
                    trailGroups[hike.trail_name].push(hike);
                });

                const allLayersGroup = L.featureGroup().addTo(homeMap);

                Object.values(trailGroups).forEach(group => {
                    // Use the shared renderer in non-interactive mode
                    const layer = renderTrailGroup(group, { isInteractive: false });
                    if (layer) {
                        allLayersGroup.addLayer(layer);
                    }
                });

                // 5. Animate the map layers
                const layersToAnimate = allLayersGroup.getLayers();

                if (layersToAnimate.length === 0) {
                    homeMap.setView([39.82, -98.58], 4); // Fallback
                } else {
                    homeMap.fitBounds(allLayersGroup.getBounds().pad(0.1));

                    layersToAnimate.forEach((layer, index) => {
                        setTimeout(() => {
                            layer.eachLayer(feature => { // feature is always a CircleMarker
                                const finalOpacity = feature.options.className.includes('breathing-halo') ? 0.5 : 0.9;
                                feature.setStyle({ fillOpacity: finalOpacity });
                            });
                        }, index * 75); // Slow down the animation by 50% for a more majestic feel
                    });
                }

                // --- Calculate and Display Stats ---
                // This code runs immediately now, no need to wait for a promise
                (function calculateAndDisplayStats() {
                    const uniqueTrails = Object.values(trailGroups);
                    const totalHikes = data.length;
                    const totalUniqueTrails = uniqueTrails.length;
                    const totalMiles = uniqueTrails.reduce((sum, group) => {
                        // Use the miles from the representative hike for each unique trail
                        // The '|| 0' handles cases where miles might be missing.
                        return sum + (group[0].miles || 0);
                    }, 0);
                    const totalElevation = data.reduce((sum, hike) => {
                        return sum + (hike.elevation_gain || 0);
                    }, 0);
                    const highestSummitHike = data
                        .filter(hike => hike.summit_trail && hike.summit_elevation)
                        .reduce((maxHike, currentHike) => {
                            // If maxHike is null or the current hike is higher, it becomes the new max
                            return (!maxHike || currentHike.summit_elevation > maxHike.summit_elevation) ? currentHike : maxHike;
                        }, null); // Start with null to handle cases with no summits

                    // Animate the main stats for a "wow" effect
                    animateCountUp('stats-hikes', totalHikes);
                    animateCountUp('stats-trails', totalUniqueTrails);
                    animateCountUp('stats-miles', Math.round(totalMiles));
                    animateCountUp('stats-elevation', Math.round(totalElevation));

                    // The "Highest Summit" stat has been moved to the "Atlas Achievements" section, so we no longer need to update it here.

                    // --- Calculate and Display Personal Records ---
                    (function calculateAndDisplayRecords() {
                        // 1. Longest Hike (by miles)
                        const longestHike = uniqueTrails.reduce((max, group) => {
                            const trailMiles = group[0].miles || 0;
                            return (max && (max[0].miles || 0) > trailMiles) ? max : group;
                        }, null);
                        if (longestHike) {
                            document.getElementById('record-longest-miles').innerText = `${Math.round(longestHike[0].miles).toLocaleString()} mi`;
                            document.getElementById('record-longest-miles-name').innerText = longestHike[0].trail_name;
                        }

                        // 2. Biggest Climb (by elevation gain)
                        const biggestClimb = uniqueTrails.reduce((max, group) => {
                            const trailElevation = group[0].elevation_gain || 0;
                            return (max && (max[0].elevation_gain || 0) > trailElevation) ? max : group;
                        }, null);
                        if (biggestClimb) {
                            document.getElementById('record-biggest-climb').innerText = `${biggestClimb[0].elevation_gain.toLocaleString()} ft`;
                            document.getElementById('record-biggest-climb-name').innerText = biggestClimb[0].trail_name;
                        }

                        // 3. Highest Summit (by summit elevation)
                        const highestSummitHike = data
                            .filter(hike => hike.summit_trail && hike.summit_elevation)
                            .reduce((maxHike, currentHike) => {
                                return (!maxHike || currentHike.summit_elevation > maxHike.summit_elevation) ? currentHike : maxHike;
                            }, null);
                        if (highestSummitHike) {
                            document.getElementById('record-highest-summit').innerText = `${highestSummitHike.summit_elevation.toLocaleString()} ft`;
                            document.getElementById('record-highest-summit-name').innerText = highestSummitHike.trail_name;
                        } else {
                            document.getElementById('record-highest-summit').innerText = '--';
                            document.getElementById('record-highest-summit-name').innerText = 'No summits recorded';
                        }

                        // 4. Busiest Month (by number of hikes in a single month across all years)
                        const monthlyHikeCounts = data.reduce((counts, hike) => {
                            const date = new Date(hike.date_completed);
                            const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                            counts[monthYear] = (counts[monthYear] || 0) + 1;
                            return counts;
                        }, {});

                        let busiestMonthYear = '';
                        let maxHikesInMonth = 0;

                        for (const [monthYear, hikeCount] of Object.entries(monthlyHikeCounts)) {
                            if (hikeCount > maxHikesInMonth) {
                                maxHikesInMonth = hikeCount;
                                busiestMonthYear = monthYear;
                            }
                        }

                        if (busiestMonthYear) {
                            const [year, month] = busiestMonthYear.split('-');
                            const date = new Date(year, month - 1);
                            const monthName = date.toLocaleDateString('en-US', { month: 'long' });
                            document.getElementById('record-busiest-month').innerText = `${monthName} ${year} (${maxHikesInMonth} hikes)`;
                        } else {
                            document.getElementById('record-busiest-month').innerText = '--';
                        }
                    })();


                    // --- Recalculate Map Bounds Now That All Trail Data is Loaded ---
                    if (layersToAnimate.length === 0) {
                        homeMap.setView([39.82, -98.58], 4); // Fallback
                    } else {
                        const allLayersGroup = L.featureGroup();
                        layersToAnimate.forEach(layer => allLayersGroup.addLayer(layer));
                        homeMap.fitBounds(allLayersGroup.getBounds().pad(0.1));

                        layersToAnimate.forEach((layer, index) => {
                            setTimeout(() => {
                                layer.eachLayer(feature => {
                                    const finalOpacity = feature.options.className.includes('breathing-halo') ? 0.5 : 0.9;
                                    feature.setStyle({ fillOpacity: finalOpacity });
                                });
                            }, index * 75);
                        });
                    }
                    // --- Calculate and Display Time Range ---
                    if (data.length > 0) {
                        // Find the earliest year in the dataset
                        const startYear = data.reduce((min, hike) => {
                            const year = new Date(hike.date_completed).getFullYear();
                            return year < min ? year : min;
                        }, new Date().getFullYear()); // Start with the current year as the initial minimum
                        document.getElementById('start-year').innerText = startYear;
                    }

                    // --- Calculate and Display First/Most Recent Hikes ---
                    if (data.length > 0) {
                        const sortedHikes = [...data].sort((a, b) => new Date(a.date_completed) - new Date(b.date_completed));
                        const firstHike = sortedHikes[0];
                        const mostRecentHike = sortedHikes[sortedHikes.length - 1];
                        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };

                        document.getElementById('first-hike-date').innerText = new Date(firstHike.date_completed).toLocaleDateString('en-US', dateOptions);
                        document.getElementById('first-hike-name').innerText = `${firstHike.trail_name} - ${firstHike.location}`;

                        document.getElementById('most-recent-hike-date').innerText = new Date(mostRecentHike.date_completed).toLocaleDateString('en-US', dateOptions);
                        document.getElementById('most-recent-hike-name').innerText = `${mostRecentHike.trail_name} - ${mostRecentHike.location}`;
                    } else {
                        document.getElementById('first-hike-date').innerText = '--';
                        document.getElementById('most-recent-hike-date').innerText = '--';
                    }
                    
                    // --- Find and Display Featured Adventure ---
                    const hikesWithTripTag = data.filter(hike => hike.trip_tag);

                    if (hikesWithTripTag.length > 0) {
                        // Find the most recent hike that is part of any trip
                        const latestTripHike = hikesWithTripTag.sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))[0];
                        const latestTripTag = latestTripHike.trip_tag;

                        // Now, gather all hikes associated with that specific trip
                        const adventureHikes = data.filter(h => h.trip_tag === latestTripTag);
                        
                        // Find the latest hike within that trip to pull the description and image from
                        const latestHikeInTrip = adventureHikes.sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))[0];

                        // Populate the title
                        document.getElementById('featured-trip-title').innerText = latestTripTag;

                        // Populate the list of hikes for the trip
                        const hikesListContainer = document.getElementById('featured-trip-hikes-list');
                        hikesListContainer.innerHTML = ''; // Clear previous content
                        adventureHikes
                            .sort((a, b) => new Date(a.date_completed) - new Date(b.date_completed)) // Sort chronologically
                            .forEach(hike => {
                                const hikeItemHtml = `
                                    <div class="featured-trip-hike-item">
                                        <h4>${hike.trail_name}</h4>
                                        <div class="hike-meta">${hike.miles} miles | ${hike.elevation_gain.toLocaleString()} ft gain</div>
                                        <p class="hike-description">${hike.description}</p>
                                    </div>
                                `;
                                hikesListContainer.innerHTML += hikeItemHtml;
                            });

                        // Calculate stats for the featured adventure
                        const tripMiles = adventureHikes.reduce((sum, h) => sum + (h.miles || 0), 0);
                        const tripElevation = adventureHikes.reduce((sum, h) => sum + (h.elevation_gain || 0), 0);
                        const tripDays = new Set(adventureHikes.map(h => h.date_completed)).size; // Count unique days
                        
                        // Populate the summary stats at the bottom with clearer labels
                        document.getElementById('featured-trip-days-stat').innerHTML = `<span class="number">${tripDays}</span><span class="label">Trip Day${tripDays !== 1 ? 's' : ''}</span>`;
                        document.getElementById('featured-trip-miles-stat').innerHTML = `<span class="number">${Math.round(tripMiles)}</span><span class="label">Total Miles</span>`;
                        document.getElementById('featured-trip-elevation-stat').innerHTML = `<span class="number">${tripElevation.toLocaleString()}</span><span class="label">Total Gain (ft)</span>`;

                        // --- NEW: Start the slideshow for the featured adventure ---
                        const featuredImageIds = adventureHikes
                            .map(h => h.images && h.images.length > 0 ? h.images[0] : null)
                            .filter(Boolean); // Filter out any nulls if a hike has no image

                        startSlideshow('#featured-adventure .featured-adventure-image-container', featuredImageIds);

                        document.getElementById('featured-adventure').style.display = 'flex';
                    }

                    // --- Find and Display the "Go-To" (Most Hiked) Trail ---
                    const trailCounts = {};
                    data.forEach(hike => {
                        if (hike.trail_name) { // Ensure trail_name exists
                            trailCounts[hike.trail_name] = (trailCounts[hike.trail_name] || 0) + 1;
                        }
                    });

                    let mostHikedTrailName = '';
                    let maxHikes = 1; // Only feature trails hiked more than once
                    for (const trailName in trailCounts) {
                        if (trailCounts[trailName] > maxHikes) {
                            maxHikes = trailCounts[trailName];
                            mostHikedTrailName = trailName;
                        }
                    }

                    if (mostHikedTrailName) {
                        const mostHikedHikes = data.filter(h => h.trail_name === mostHikedTrailName);
                        const representativeHike = mostHikedHikes.sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))[0];

                        const totalMiles = mostHikedHikes.reduce((sum, h) => sum + (h.miles || 0), 0);
                        const totalElevation = mostHikedHikes.reduce((sum, h) => sum + (h.elevation_gain || 0), 0);

                        document.getElementById('goto-trail-title').innerText = representativeHike.trail_name;
                        document.getElementById('goto-trail-description').innerText = representativeHike.description;

                        const datesHtml = mostHikedHikes
                            .sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))
                            .map(h => `<li>${new Date(h.date_completed).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}</li>`)
                            .join('');
                        document.getElementById('goto-trail-dates-list').innerHTML = `<h4>Dates Hiked:</h4><ul>${datesHtml}</ul>`;

                        document.getElementById('goto-trail-times-hiked-stat').innerHTML = `<span class="number">${maxHikes}</span><span class="label">Times Hiked</span>`;
                        document.getElementById('goto-trail-miles-stat').innerHTML = `<span class="number">${Math.round(totalMiles)}</span><span class="label">Total Miles</span>`;
                        document.getElementById('goto-trail-elevation-stat').innerHTML = `<span class="number">${totalElevation.toLocaleString()}</span><span class="label">Total Gain (ft)</span>`;

                        // --- NEW: Start the slideshow for the go-to trail ---
                        const gotoImageIds = mostHikedHikes
                            .map(h => h.images && h.images.length > 0 ? h.images[0] : null)
                            .filter(Boolean);
                        
                        startSlideshow('#goto-trail-section .featured-adventure-image-container', gotoImageIds);
                        document.getElementById('goto-trail-section').style.display = 'flex';
                    }

                    // --- Create Recent Hikes Trail Log ("From the Field") ---
                    (function createTrailLog() {
                        const trailLogContainer = document.getElementById('trail-log-section');
                        if (!trailLogContainer) return;

                        // Sort all hikes by date, most recent first, and take the top 3
                        const recentHikes = [...data]
                            .sort((a, b) => new Date(b.date_completed) - new Date(a.date_completed))
                            .slice(0, 3);

                        if (recentHikes.length === 0) {
                            trailLogContainer.innerHTML = '<p>No recent hikes to display.</p>';
                            return;
                        }

                        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };

                        // Generate the HTML for each card
                        const cardsHtml = recentHikes.map(hike => `
                            <div class="trail-log-card">
                                <div>
                                    <h4>${hike.trail_name}</h4>
                                    <p class="location-date">${new Date(hike.date_completed).toLocaleDateString('en-US', dateOptions)} &bull; ${hike.location}</p>
                                </div>
                                <div class="trail-log-stats">
                                    <div class="stat">
                                        <span class="stat-icon">üìè</span>
                                        <span class="stat-value">${hike.miles} mi</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-icon">üßó</span>
                                        <span class="stat-value">${hike.elevation_gain.toLocaleString()} ft</span>
                                    </div>
                                </div>
                            </div>`).join('');

                        trailLogContainer.innerHTML = cardsHtml;
                    })();

                    // --- NEW: Interactive US Map ---
                    (function setupInteractiveMap() {
                        const container = document.getElementById('interactive-map-container');
                        const tooltip = document.getElementById('map-tooltip');
                        if (!container || !tooltip) return;

                        fetch('assets/state-icons/blank-us-map.svg')
                            .then(response => response.text())
                            .then(svgData => {
                                container.innerHTML = svgData;
                                const svg = container.querySelector('svg');
                                svg.id = 'us-map-svg';

                                // Remove all inline styles and presentation attributes from SVG paths
                                const paths = svg.querySelectorAll('path');
                                paths.forEach(path => {
                                    path.removeAttribute('style');
                                    path.removeAttribute('fill');
                                    path.removeAttribute('stroke');
                                    path.removeAttribute('stroke-width');
                                    path.removeAttribute('class'); // Remove class attribute as well
                                });

                                // Remove the inline style block from the SVG
                                const styleElement = svg.querySelector('style');
                                if (styleElement) {
                                    styleElement.remove();
                                }

                                // Remove class from the main group element if it exists
                                const gElement = svg.querySelector('g.state');
                                if (gElement) {
                                    gElement.removeAttribute('class');
                                }

                                // Explicitly set default fill and stroke for all paths to ensure external CSS takes over
                                paths.forEach(path => {
                                    path.setAttribute('fill', '#e9e4db'); // Default fill for non-hiked states
                                    path.setAttribute('stroke', '#bab3a9'); // Default stroke for all states
                                    path.setAttribute('stroke-width', '1px');
                                });

                                const stateStats = data.reduce((stats, hike) => {
                                    const region = hike.region || '';
                                    const stateAbbr = region.split(', ').pop();
                                    if (stateAbbr) {
                                        if (!stats[stateAbbr]) {
                                            stats[stateAbbr] = { totalHikes: 0, totalMiles: 0, uniqueTrails: new Set() };
                                        }
                                        stats[stateAbbr].totalHikes++;
                                        stats[stateAbbr].totalMiles += hike.miles || 0;
                                        stats[stateAbbr].uniqueTrails.add(hike.trail_name);
                                    }
                                    return stats;
                                }, {});

                                const stateNames = {
                                    "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas", "CA": "California",
                                    "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "FL": "Florida", "GA": "Georgia",
                                    "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa",
                                    "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland",
                                    "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri",
                                    "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey",
                                    "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "OH": "Ohio",
                                    "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island", "SC": "South Carolina",
                                    "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont",
                                    "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming", "DC": "District of Columbia"
                                };

                                Object.keys(stateStats).forEach(stateAbbr => {
                                    const statePath = svg.querySelector(`.${stateAbbr.toLowerCase()}`); // SVG uses lowercase class names
                                    if (statePath) {
                                        statePath.classList.add('active');
                                        statePath.dataset.hikes = stateStats[stateAbbr].totalHikes;
                                        statePath.dataset.miles = Math.round(stateStats[stateAbbr].totalMiles);
                                        statePath.dataset.trails = stateStats[stateAbbr].uniqueTrails.size;
                                        statePath.dataset.stateName = stateNames[stateAbbr] || stateAbbr;
                                    }
                                });

                                svg.addEventListener('mouseover', e => {
                                    if (e.target.classList.contains('active')) {
                                        const { stateName, hikes, miles, trails } = e.target.dataset;
                                        tooltip.innerHTML = `<h4>${stateName}</h4><p>${hikes} Hikes ‚Ä¢ ${trails} Unique Trails ‚Ä¢ ${miles} Miles</p>`;
                                        tooltip.style.display = 'block';
                                    }
                                });

                                svg.addEventListener('mousemove', e => {
                                    tooltip.style.left = `${e.pageX + 15}px`;
                                    tooltip.style.top = `${e.pageY}px`;
                                });

                                svg.addEventListener('mouseout', () => {
                                    tooltip.style.display = 'none';
                                });
                            });
                    })();

                    // --- NEW: Create Seasonal Heatmap ---
                    (function createSeasonalHeatmap() {
                        const heatmapContainer = document.getElementById('seasonal-heatmap');
                        if (!heatmapContainer) return; // Exit if the container isn't on the page

                        // 1. Tally hikes per month (0-11 index for Jan-Dec)
                        const monthCounts = Array(12).fill(0);
                        data.forEach(hike => {
                            // Use getUTCMonth to avoid timezone issues with simple 'YYYY-MM-DD' dates
                            const month = new Date(hike.date_completed).getUTCMonth();
                            monthCounts[month]++;
                        });

                        // 2. Determine the min and max hike counts for dynamic scaling
                        const maxCount = Math.max(...monthCounts);
                        const minCount = Math.min(...monthCounts);

                        // 3. Define a function to get the heat level based on hike count
                        const getHeatLevel = (count) => {
                            if (maxCount === minCount) {
                                // Handle the case where all counts are the same
                                return count > 0 ? 3 : 0; // Mid-level if hikes exist, otherwise zero
                            }

                            // Dynamic scaling to 7 levels
                            const normalizedCount = (count - minCount) / (maxCount - minCount);
                            return Math.round(normalizedCount * 6);
                        };


                        const monthAbbreviations = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];


                        // 4. Clear placeholders and generate the HTML for each month block
                        heatmapContainer.innerHTML = '';
                        monthAbbreviations.forEach((abbr, index) => {
                            const count = monthCounts[index];
                            const heatLevel = getHeatLevel(count);
                            const tooltipText = `${abbr}: ${count} hike${count !== 1 ? 's' : ''}`;
                            // Display the count within a visually distinct container
                            const displayText = `${abbr}<div class="hike-count-badge">${count}</div>`;
                            heatmapContainer.innerHTML += `
                                <div class="heatmap-month heat-level-${heatLevel}">${displayText}</div>`;
                        });
                    })();
                })();
            }) .catch(error => {
                console.error("Error loading homepage map data:", error);
                homeMap.setView([39.82, -98.58], 4);
            });

        // --- Helper function for the count-up animation ---
        function animateCountUp(elementId, finalValue, duration = 2000) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = Math.floor(progress * finalValue);
                element.innerText = currentValue.toLocaleString();

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
   </script>
   <script>
        // --- NEW: Reusable Slideshow Function ---
        function startSlideshow(containerSelector, imageIds, interval = 10000) {
            const container = document.querySelector(containerSelector);
            // Use a more robust fallback image path
            const fallbackImage = 'assets/landscapes/fallback-hero.jpg';

            if (!container || imageIds.length === 0) {
                if (container) {
                    container.innerHTML = `<img src="${fallbackImage}" alt="Trail photo" class="slideshow-image active">`;
                }
                return;
            }

            container.innerHTML = ''; // Clear existing content
            const imageElements = [];

            imageIds.forEach((id, index) => {
                const img = document.createElement('img');
                img.src = `https://res.cloudinary.com/dgdniwosl/image/upload/w_800,h_600,c_fill,q_auto,f_auto/${id}`;
                img.alt = "A photo from the trail";
                img.className = 'slideshow-image';
                if (index === 0) {
                    img.classList.add('active');
                }
                container.appendChild(img);
                imageElements.push(img);
            });

            if (imageElements.length <= 1) return; // No need for a slideshow with one image

            let currentIndex = 0;
            setInterval(() => {
                imageElements[currentIndex].classList.remove('active');
                currentIndex = (currentIndex + 1) % imageElements.length;
                imageElements[currentIndex].classList.add('active');
            }, interval);
        }
   </script>
   <!-- Shared script to update the 'Latest Hike' nav link -->
   <script src="scripts/nav-updater.js"></script>
</body>
</html>